<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="google" content="notranslate">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Start: HiLex</title>
        <!-- css -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="scripts_jscssphp/main.css">
        <!-- js -->
        <!--<script src='https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js'></script>-->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script type="text/javascript">
            $(function () {	$('#my_nav').load('static/head_nonav_min.html');
            				$('#my_foot').load('static/foot_minParticipant.html'); });
        </script>
        <!-- favicons -->
        <link rel="apple-touch-icon" sizes="180x180" href="images/fav/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="images/fav/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="images/fav/favicon-16x16.png">
		<link rel="manifest" href="images/fav/site.webmanifest">
		<!-- css -->
		<style type="text/css">
			.card { background-color: #002349; }
			.btn-primary { background-color: #F4C654 !important; border-color: #F4C654 !important;}
			.btn-outline-primary {	border-color: #F4C654 !important; color: #F4C654 !important; }
		</style>
	</head>

	<body>
		<!-- Navigation-->
		<div id="my_nav"></div>
		<!-- Header-->    
	
	<!-- Hidden content START -->
	<div class="container" id="lineHide"  style="margin-bottom: 10px; margin-top: 33.3333px; overflow: auto; min-height: calc(100% - 150px);">
	    <center>
	        <h2 style="font-weight: bold;"><br><br><br>
	        	<a id="err1_main">Error in URL !!!</a>
	        <br><br><br></h2>
	        <p>
	            <a id="err2_sub">Enter valid URL; You don't have access to the portal.</a>
	            <br><br>
	            <a id="err3_contact">Please contact experimenter or write to <a href="mailto:niket_cct@yahoo.com">niket_cct@yahoo.com</a></a>
	        </p>
	    </center>
	</div>
	<!-- Hidden content END -->

	<div id="StartBox" class="container" style="margin-bottom: 10px; margin-top: 33.3333px; overflow: auto; min-height: calc(100% - 150px);">
		<div class="row justify-content-center">


			<div class="card  col-sm-12 col-lg-6">
  				<div class="card-body">
    				<h5 class="card-title">Participation code and Email address</h5>
    				<p class="card-text">You now have the opportunity to fill in the participant's name and, if desired, one or more email addresses (i.e., the researcher's and/or the participant's) that the score will be sent to.</p>
    				<p class="card-text">When you are ready, click the "Next" button to begin the experiment (starting with an instruction screen for the participant).</p>
    				<p class="card-text">All your data will be anonymised with this code. Your email ID will just be used to send scores.</p>


    				<form id="start" name="start">
    					<div class="card-text form-group row" id="pid_head1">
    						<label class="col-sm-5 control-label text-left" id='i00'>Experimenter (auto)</label>
    						<div class="col-sm-7">
    							<input readonly type="text" class="form-control" placeholder="(ABC PQR) exptABBR" name="exptid" id="eid_auto">
    						</div>
						</div>
						<div class="card-text form-group row" id="pid_head2">
    						<label class="col-sm-5 control-label text-left" id='i01'>Participation ID (auto)</label>
    						<div class="col-sm-7">
    							<input readonly type="text" class="form-control" placeholder="enter or contact experimenter" name="partid" id="pid_auto">
    						</div>
						</div>
						<div class="card-text form-group row" id="pid_head3">
    						<label class="col-sm-5 control-label text-left" id='i02'>Your email address</label>
    						<div class="col-sm-7">
    							<input type="email" class="form-control" placeholder="enter mail to receive scores" name="emailid" id="email_type" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$">  
    						</div>
						</div>
		
					</form>

					<br>

	    			<!--a id="linkProfile" href="#abc" class="btn btn-primary" style="color: black; font-weight: bold;" onclick="triggerFunc()">Go to HiLex</a-->
	    			<br>
	    			<a id="linkProfile" href="#abc" class="btn btn-primary px-5" style="color: black; font-weight: bold; float: right;">Go to HiLex</a>

  				</div>
  			</div>
  			
  		</div>

  	</div>

<!-- Footer-->
<div id="my_foot"></div>


</body>
<script type="module">
	document.getElementById("start").addEventListener("keydown", function(event) {
		// check if the Enter key was pressed
		if (event.keyCode === 13) {
			event.preventDefault(); // prevent the form from submitting
			document.getElementById('linkProfile').click();
		}
	});

	function checkPartDataExists(pID, eID) {
		var jsonPart = (function() { var json = null;
			$.ajax({'async': false, 'global': false, 'cache':false, 'url': "./data_experimenters/data/"+eID+"_HiLex.json", 'dataType': "json",
				'success': function(data) { json = data; } });
		return json;})();
		//console.log(jsonPart);
		jsonPart = jsonPart.some(obj => obj['partID'] === $("#pid_auto").val().replace('-',''));
		console.log(jsonPart)
		if(jsonPart) {
			document.getElementById('err1_main').innerHTML = "Participation ID already used"
			document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. Something is wrong in pID."
			console.log("INVALID - USED PID")
			$('#lineHide').css("display", "");
			$('#StartBox').css("display", "None");
		}
	}

	function checkPartID(jsonData, pID, eID, optID) {
		var roster = (function() { var json = null;
			$.ajax({'async': false, 'global': false, 'cache':false, 'url': "data_experimenters/rosters/"+eID+"_roster.json", 'dataType': "json",
				'success': function(data) { json = data; } });
		return json;})();
		var pID_in_Roster = roster.some(obj => obj['participantID'] === pID);
		//f/m/n + y/n + y/n + r/s/c/f + y/n
		//LBQ(Full/Min/No) + ShowScore(Y/N) + Email(Y/N) + PartID(Rand/Seq/Cust/Polf) + Redirect(Y/N)
		if(optID[2]==jsonData.typePartID[0] && pID_in_Roster && optID[2]=='r') { //Random PID condition
			document.getElementById('pid_auto').value = jsonData.ExptAbbr + '-'+ pID; }
		else if(optID[2]==jsonData.typePartID[0] && Number(pID)<=Number(jsonData.ExptNsub) && optID[2]=='s') { //Sequential PID condition
			document.getElementById('pid_auto').value = jsonData.ExptAbbr + '-'+ pID; }
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='c' && pID=='{{enter-Part-ID-here}}' && pID!=null) { //Custom PID (if PID not supplied, as it is URL)
			document.getElementById('i01').innerHTML = 'Participation ID *';
			document.getElementById('pid_auto').removeAttribute('readonly');
			//document.getElementById('pid_auto').placeholder = jsonData.ExptAbbr + '-'+ pID; 
			/////////// old code /////////////
			pid_auto.value = jsonData.ExptAbbr+'-'; }
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='c' && (pID==null || pID=='')) { // (either PID variable not used, or supplied blank)
			document.getElementById('i01').innerHTML = 'Participation ID *';
			document.getElementById('pid_auto').removeAttribute('readonly'); 
			pid_auto.value = jsonData.ExptAbbr+'-'; }
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='c' && pID!=null && pID!='') { // (if PID supplied, as it is URL)
			document.getElementById('pid_auto').value = jsonData.ExptAbbr + '-'+ pID; }
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='p' && pID=='{{%PROLIFIC_PID%}}' && pID!=null) { //Prolific
			document.getElementById('i01').innerHTML = 'Participation ID *';
			document.getElementById('pid_auto').removeAttribute('readonly'); 
			//document.getElementById('pid_auto').placeholder = jsonData.ExptAbbr + '-'+ pID; 
			pid_auto.value = jsonData.ExptAbbr+'-'; } 
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='p' && (pID==null || pID=='')) {
			document.getElementById('i01').innerHTML = 'Participation ID *';
			document.getElementById('pid_auto').removeAttribute('readonly'); 
			pid_auto.value = jsonData.ExptAbbr+'-'; }
		else if(optID[2]==jsonData.typePartID[0] && optID[2]=='p') {
			document.getElementById('pid_auto').value = jsonData.ExptAbbr + '-'+ pID; }
		else {
			document.getElementById('err1_main').innerHTML = "Invalid Participation ID"
			document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. Something is wrong in pID."
			console.log("INVALID - WRONG PID")
			$('#lineHide').css("display", "");
			$('#StartBox').css("display", "None");
		//console.log(pID_in_Roster);
		//console.log(roster);
		//console.log(optID)
		// check if random & type r -- update random (check roster)
		// check if prolific & type p -- update prol, allow bullshit (do not check roster)
		// check if seq & type s -- update seq (check is seq < n)
		// check if custom & type c & {{}} -- remove readonly, allow to type
		}
	}

	/*function checkEmailID(jsonData, optID) {
		//f/m/n + y/n + y/n + r/s/c/f + y/n
		//LBQ(Full/Min/No) + ShowScore(Y/N) + Email(Y/N) + PartID(Rand/Seq/Cust/Polf) + Redirect(Y/N)
		if(optID[2]==jsonData.ifEmail && optID[2]=='y') { 
			document.getElementById('email_type').placeholder = 'enter to receive scores'; }
		else if(optID[2]==jsonData.ifEmail && optID[2]=='n') {
			$('#pid_head3').css("display", "None");
		}
	}*/

	function checkLBQ(jsonData, eID, optID) {
		if(optID[0]==jsonData.ifLBQ[0] && optID[0]=='f') {
			//$("#linkProfile")[0].href = "profile-full.html?expID="+eID+"&partID="+"Niket"; }
			$("#linkProfile")[0].href = "profile-full.html" }
		else if(optID[0]==jsonData.ifLBQ[0] && optID[0]=='m') {
			$("#linkProfile")[0].href = "profile-min.html"; }
		else if(optID[0]==jsonData.ifLBQ[0] && optID[0]=='n') {
			$("#linkProfile")[0].href = "profile-no.html"; }
		else {
			document.getElementById('err1_main').innerHTML = "Invalid Option ID"
			document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. Something is wrong in optID."
			console.log("INVALID - WRONG OID")
			$('#lineHide').css("display", "");
			$('#StartBox').css("display", "None");
		}
	}

	function checkRedirect(jsonData, eID, optID) {
		if(optID[3]==jsonData.ifCallBack && optID[3]=='y') {
			rdrctURL = jsonData.cbURL;
		}
		else if(optID[3]==jsonData.ifCallBack && optID[3]=='n') {
			rdrctURL = 'http://worrydream.com/404'
		}
		else {
			document.getElementById('err1_main').innerHTML = "Invalid Option ID"
			document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. Something is wrong in redirect options."
			console.log("INVALID - WRONG OID")
			$('#lineHide').css("display", "");
			$('#StartBox').css("display", "None");
		}
		console.log(rdrctURL)

	}

	function checkExpiry(jsonData, eID) {
		var today = new Date();
		if(today.toJSON() > jsonData.expireExpt) {
			document.getElementById('err1_main').innerHTML = "Experiment expired"
			document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. The experimenter needs to set up experiment again."
			console.log("INVALID - EXPIRED")
			$('#lineHide').css("display", "");
			$('#StartBox').css("display", "None");
		}
	}

	function triggerFunc() { 
		if (start.reportValidity() && pid_auto.value!=jsonData.ExptAbbr+'-') {
			console.log("Valid data")
			var data = {eID: eID, pID: $("#pid_auto").val().replace('-',''), emailID: $("#email_type").val(), options: optID, URLrdct:rdrctURL, emailExpt: jsonData.ExptEmail, nameExpt: jsonData.ExptName, abbrExpt: jsonData.ExptAbbr};
			sessionStorage.setItem("startData", JSON.stringify(data));
			console.log('sessionStorage set [1_START]')
			//if($("#linkProfile")[0].href == "http://localhost/projects/Exp_web_v8/FULL") $("#linkProfile")[0].href = "profile-full.html";
			//SET LBQ TYPE
    		checkLBQ(jsonData, eID, optID);
		} else if (pid_auto.value==jsonData.ExptAbbr+'-') {
			alert("Invalid data - Participant ID is missing\n Pls write identifier after dash or contact experimenter");
			console.log("Invalid data")
		}
		else { 
			$("#linkProfile")[0].href = "#"; 
			console.log("Invalid data");
		}
	}

	import expData from './data_experimenters/all_expts.json' assert { type: 'json' };
	var jsonData = expData
	console.log(jsonData);

	const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const eID = urlParams.get('expID');
    const pID = urlParams.get('pid');
    const optID = urlParams.get('options');
    var rdrctURL = jsonData.cbURL;
    
    if(eID!=null && optID!=null) {
    	$('#lineHide').css("display", "None");
    	console.log("All 2 present - GOOD");
    	console.log(eID, pID, optID);
    	//EXP_ID OKAY
    	jsonData = jsonData.filter(obj => obj.ExptID.includes(eID))[0];
    	document.getElementById('eid_auto').value = jsonData.ExptName+' ('+jsonData.ExptID.slice(-7)+')';
    	//PART_ID TYPE and ID OKAY
    	checkPartID(jsonData, pID, eID, optID);
    	//EMAIL IS OKAY
    	//checkEmailID(jsonData, optID);
    	//CHECK REDIRECT
    	checkRedirect(jsonData, eID, optID);
    	//CHECK EXPIRY
    	checkExpiry(jsonData, eID);
    	checkPartDataExists(pID, eID);
    } else {
    	document.getElementById('err1_main').innerHTML = "Invalid URL"
    	document.getElementById('err2_sub').innerHTML = "You don't have access to the portal. Something is missing in URL."
    	console.log("INVALID - SOMETHING MISSING IN URL")
    	$('#lineHide').css("display", "");
    	$('#StartBox').css("display", "None");
    }

    //(expose variables from inside module to outside)
    //window.jsonData = jsonData;
	//window.eID = eID;

	//https://stackoverflow.com/questions/44590393/es6-modules-undefined-onclick-function-after-import
	document.querySelector('#linkProfile').addEventListener('click', triggerFunc);

	$("#pid_auto").keydown(function(e) {
        var oldvalue=$(this).val();
        var field=this;
        setTimeout(function () {
            if(field.value.indexOf(jsonData.ExptAbbr+'-') !== 0) {
                $(field).val(oldvalue);
            } 
        }, 1);
    });

</script>

</html>